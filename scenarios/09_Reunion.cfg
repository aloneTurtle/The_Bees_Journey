#textdomain wesnoth-The_Bees_Journey

[scenario]
    id=09_Reunion
    name= _ "Reunion"+ _ " (Draft)"

    next_scenario=10_Daydream_Memories
    map_file=09_Reunion.map

    disallow_recall=yes
    victory_when_enemies_defeated=no

    turns=24
    {FIRST_WATCH}
    {FIRST_WATCH}
    {FIRST_WATCH}
    {FIRST_WATCH}
    {FIRST_WATCH}
    {FIRST_WATCH}
    {FIRST_WATCH}
    {FIRST_WATCH}
    {MIDNIGHT}
    {MIDNIGHT}
    {MIDNIGHT}
    {MIDNIGHT}
    {MIDNIGHT}
    {MIDNIGHT}
    {MIDNIGHT}
    {MIDNIGHT}
    {SECOND_WATCH}
    {SECOND_WATCH}
    {SECOND_WATCH}
    {SECOND_WATCH}
    {SECOND_WATCH}
    {SECOND_WATCH}
    {SECOND_WATCH}
    {SECOND_WATCH}
    {DAWN}

    {INTRO_AND_SCENARIO_MUSIC "calm-before-storm.ogg" "breeze.ogg"}
    {EXTRA_SCENARIO_MUSIC "journeys_end.ogg"}

    {WORK_IN_PROGRESS_WARNING}

    [story]
        [part]
            story= _ "FIXME"
            show_title=yes
        [/part]
    [/story]

    [side]
        side=1
        controller=human
        team_name=heroes
        user_team_name= _ "team_name^Marie"

        type=Princess Bee
        id=Marie
        name= _ "Marie"
        unrenamable=yes
        canrecruit=yes

        recruit=Bee,Drone

        shroud=yes
        fog=yes

        {FLAG_VARIANT long}
        gold=0
        village_gold=0
        {NO_INCOME}
    [/side]

#define AVOID_BEES OWN_SIDE
    [attacks]
        invalidate_on_gamestate_change=yes
        [filter_own]
            side={OWN_SIDE}
        [/filter_own]
        [filter_enemy]
            [not]
                side=5
            [/not]
        [/filter_enemy]
    [/attacks]
#enddef

    [side]
        side=2
        controller=ai
        team_name=enemies
        user_team_name= _ "team_name^Hornets"

        type=Great Hornet
        id=Elgair
        name= _ "Elgair"
        canrecruit=yes

        recruit=Soulless

        share_vision=none

        {FLAG_VARIANT6 ragged}
        {GOLD 20 30 40}
        {INCOME 0 2 4}

        {KAMIKAZE_AI (
            passive_leader=yes

            {AVOID_BEES 2}
        )}
    [/side]

    {RECRUIT_UNIT_VARIATIONS 2 "Soulless" ant,spider}

    [event]
        name=side 2 turn refresh
        first_time_only=no

        [modify_unit]
            [filter]
                side=2
            [/filter]
            moves=3
        [/modify_unit]
    [/event]

    [side]
        side=3
        controller=ai
        team_name=enemies
        user_team_name= _ "team_name^Hornets"

        no_leader=yes
        hidden=yes

        fog=yes

        share_vision=none

        color=purple
        {FLAG_VARIANT6 ragged}

        [ai]
            ai_algorithm=idle_ai

            {AVOID_BEES 3}
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai
        team_name=enemies
        user_team_name= _ "team_name^Hornets"

        no_leader=yes
        hidden=yes

        fog=yes

        share_vision=none

        color=purple
        {FLAG_VARIANT6 ragged}

        {KAMIKAZE_AI (
            {AVOID_BEES 4}
        )}
    [/side]

#undef AVOID_BEES

    # Temporary hive for bees
    [side]
        side=5
        controller=null
        team_name=heroes
        user_team_name= _ "team_name^Marie"

        no_leader=yes
        hidden=yes

        fog=yes

        share_vision=none

        color=red
        {FLAG_VARIANT long}
    [/side]

    {STARTING_VILLAGES 2 4}

    [event]
        name=prestart
        [objectives]
            [objective]
                description= _ "Return to Marie"
                condition=win
            [/objective]

            [objective]
                description= _ "Death of Dragochan"
                condition=lose
            [/objective]
            [objective]
                description= _ "Destruction of Kaldyn"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=no
                carryover_percentage=100
            [/gold_carryover]
        [/objectives]

        #
        # Initial player-side settings
        #

        [disallow_recruit]
            side=1
        [/disallow_recruit]

        [if]
            [have_unit]
                # wmllint: recognize Clovis
                id=Clovis
                search_recall_list=yes
            [/have_unit]
            [then]
                [recall]
                    id=Clovis
                    x,y=16,40
                [/recall]
                [recall]
                    id=Noaille
                    x,y=20,44
                [/recall]
            [/then]
            [else]
                [recall]
                    id=Noaille
                    x,y=16,40
                [/recall]
                [terrain]
                    x,y=20,40
                    terrain=Hh
                [/terrain]
            [/else]
        [/if]

        [role]
            role=lookout
            x,y=16,40
        [/role]

        [recall]
            id=Imorin
            x,y=17,40
        [/recall]
        [recall]
            id=Yoshie
            x,y=17,41
        [/recall]

        {MODIFY_UNIT (side=1) side 5}

        [capture_village]
            side=5
            x,y=14,44
        [/capture_village]
        [capture_village]
            side=5
            x,y=19,43
        [/capture_village]
        [capture_village]
            side=5
            x,y=18,38
        [/capture_village]

        [remove_shroud]
            side=1
            [filter]
                id=Marie
            [/filter]
            radius=1
        [/remove_shroud]
        [remove_shroud]
            side=1
            [filter]
                role=lookout
            [/filter]
            radius=2
        [/remove_shroud]

        # wmllint: recognize Dragochan
        {UNSTORE_UNIT Dragochan_store (x,y,fire_event=3,3,yes)}

        # wmllint: recognize Kaldyn
        {UNSTORE_UNIT Kaldyn_store (x,y,fire_event=4,2,yes)}

        # Slow Dragochan down a little
        [object]
            duration=scenario
            [filter]
                id=Dragochan
            [/filter]

            [effect]
                apply_to=movement_costs
                replace=no
                [movement_costs]
                    hills=1
                    mountains=1
                [/movement_costs]
            [/effect]
        [/object]

        # Set Dragochan as interim leader
        {MODIFY_UNIT (id=Dragochan) canrecruit yes}
        [remove_unit_overlay]
            id=Dragochan
            image=misc/hero-icon.png
        [/remove_unit_overlay]

        # Enemy subleader
        [unit]
            type=Great Hornet
            generate_name=yes
            side=2
            random_traits=no
            [modifications]
                {TRAIT_LOYAL_HERO_NOSLOT}
            [/modifications]
            x,y=20,21
            ai_special=guardian
        [/unit]

        #
        # Seekers
        #

        [random_placement]
            num_items={ON_DIFFICULTY 3 5 7}
            variable=loc
            min_distance=3
            [filter_location]
                terrain=*^F*
                x=4-19
                y=9-36
            [/filter_location]
            [command]
#ifdef HARD
                {RANDOM "Assault,Assault,Warrior"}
#else
                {RANDOM "Assault,Warrior,Warrior"}
#endif

                [unit]
                    side=3
                    type=$random Hornet
                    vision=3
                    x,y=$loc.x,$loc.y
                [/unit]

                {CLEAR_VARIABLE random}
            [/command]
        [/random_placement]
        [random_placement]
            num_items={ON_DIFFICULTY 3 5 7}
            variable=loc
            min_distance=3
            [filter_location]
                terrain=Hh^*,Ww^*,Ss^*,G*^*
                x=4-21
                y=13-36
            [/filter_location]
            [command]
                [unit]
                    side=3
                    type=Wraith
                    vision=3
                    x,y=$loc.x,$loc.y
                [/unit]

                # {RANDOM "yes,no,no"}

                # [if]
                #     [variable]
                #         name=random
                #         boolean_equals=yes
                #     [/variable]
                #     [then]
                #         [object]
                #             duration=scenario
                #             [filter]
                #                 x,y=$loc.x,$loc.y
                #             [/filter]

                #             [effect]
                #                 apply_to=new_ability
                #                 [abilities]
                #                     {ABILITY_NIGHTSTALK}
                #                 [/abilities]
                #             [/effect]
                #         [/object]
                #     [/then]
                # [/if]

                # {CLEAR_VARIABLE random}
            [/command]
        [/random_placement]

        {MODIFY_UNIT (side=1) facing se}
        {MODIFY_UNIT (side=2,5) facing nw}
    [/event]

    {FORCE_CHANCE_TO_HIT (side=4) (side=1) {ON_DIFFICULTY 20 30 40} ()}
    {FORCE_CHANCE_TO_HIT (side=1) (side=4) {ON_DIFFICULTY 80 70 60} ()}

    [event]
        name=start

        [sound]
            name=wail-sml.wav
        [/sound]

        [move_unit_fake]
            type=Assault Hornet
            side=4
            x=1,2,3,4,5,6
            y=5,5,6,5,6,6
        [/move_unit_fake]

        {DELAY 250}

        [sound]
            name=wail-long.wav
        [/sound]

        [move_unit_fake]
            type=Wraith
            side=4
            x=6,7,8,9
            y=5,5,4,5
        [/move_unit_fake]
        [move_unit_fake]
            type=Ghost
            side=4
            x=6,7,8
            y=5,6,6
        [/move_unit_fake]

        {DELAY 250}

        [message]
            speaker=Kaldyn
            message= _ "..."
        [/message]

        {DELAY 750}

        [message]
            speaker=Kaldyn
            message= _ "That was close... I can only hide us here for so long. We should leave here while we can."
        [/message]
        [message]
            speaker=Dragochan
            message= _ "Sure, Marie will be worried about us."
        [/message]
        [message]
            speaker=Kaldyn
            message= _ "I’m not talking about going back to those dangerous insects. I’m saying that we should leave this island."
        [/message]
        [message]
            speaker=Dragochan
            message= _ "..."
        [/message]
        [message]
            speaker=Kaldyn
            message= _ "What? Are you expecting a group of drakes to come to your rescue? Once you turned down Dilan’s proposal, that chance should have vanished for you."
        [/message]
        [message]
            speaker=Kaldyn
            message= _ "If we can gather enough wood from around here, we can build a raft. You and I can do it together."
        [/message]
        [message]
            speaker=Dragochan
            message= _ "..."
        [/message]

        {DELAY 1000}

        [message]
            speaker=Dragochan
            message= _ "I will never abandon the bees, nor will I indulge in your folly. What about you? If you left on your own, then at the sight of first saw hornet you encountered, you’d scream and be surrounded in no time."
        [/message]
        [message]
            speaker=Kaldyn
            message= _ "..."
        [/message]
        [message]
            speaker=Dragochan
            message= _ "We return to Marie."
        [/message]

        # Roaming enemies
        [micro_ai]
            side=2
            ai_type=big_animals
            action=add

            [filter]
                type=Soulless,Mudcrawler
            [/filter]
            [filter_location]
                x=4-21
                y=9-36
            [/filter_location]
        [/micro_ai]
    [/event]

    [event]
        name=attack
        [filter]
            race=undead
        [/filter]
        [filter_second]
            race=undead
        [/filter_second]

        [message]
            speaker=Kaldyn
            message= _ "FIXME"
        [/message]
    [/event]
    [event]
        name=attack end
        [filter]
            race=undead
        [/filter]
        [filter_second]
            race=undead
        [/filter_second]

        [message]
            speaker=Dragochan
            message= _ "FIXME"
        [/message]
    [/event]

    [event]
        name=turn 7

        {GENERIC_UNIT 2 (Mudcrawler) 15 3}
        {GENERIC_UNIT 2 (Mudcrawler) 15 4}
        {GENERIC_UNIT 2 (Mudcrawler) 16 3}
    [/event]
    [event]
        name=turn 15

        {GENERIC_UNIT 2 (Mudcrawler) 5 34}
        {GENERIC_UNIT 2 (Mudcrawler) 6 33}
        {GENERIC_UNIT 2 (Mudcrawler) 6 34}
    [/event]

    [event]
        name=sighted
        [filter]
            side=3
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [redraw]
            clear_shroud=yes
        [/redraw]

        [fire_event]
            name=seeker warning
        [/fire_event]
    [/event]
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                [filter]
                    side=3
                [/filter]
                radius=5
            [/filter_location]
        [/filter]

        [redraw]
            clear_shroud=yes
        [/redraw]

        [fire_event]
            name=seeker warning
        [/fire_event]
    [/event]

    [event]
        name=seeker warning
        [message]
            speaker=Kaldyn
            message= _ "FIXME"
        [/message]
    [/event]

    [event]
        name=side turn
        first_time_only=no

        # Make their vision clearer for the player
        [modify_unit]
            [filter]
                side=3
            [/filter]
            moves=3
            max_moves=3
        [/modify_unit]
    [/event]

    #
    # Essentially the same as "Hide and Seek" in Liberty
    #
    [event]
        name=side 3 turn
        first_time_only=no

        [if]
            [have_unit]
                side=1
                [filter_vision]
                    visible=yes
                    side=3
                [/filter_vision]

                [or]
                    side=1
                    [filter_vision]
                        visible=yes
                        side=4
                    [/filter_vision]
                [/or]
            [/have_unit]
            [then]
                [modify_unit]
                    [filter]
                        side=3
                        [filter_location]
                            [filter]
                                side=1
                            [/filter]
                            radius=8
                        [/filter_location]
                    [/filter]
                    side=4
                    moves,max_moves=5,5
                [/modify_unit]
            [/then]
            [else]
                {MODIFY_UNIT (side=4) side 3}
            [/else]
        [/if]
    [/event]

    # TODO: In-scenario dialogue (roughly wrapping up Kaldyn's backstory)
    [event]
        name=turn 4

        {VARIABLE dialogue_count 0}

        [event]
            name=moveto,attack end
            first_time_only=no

            [filter]
                id=Dragochan,Kaldyn
            [/filter]

            [switch]
                variable=dialogue_count
                [case]
                    value=3

                    [message]
                        speaker=Dragochan
                        message= _ "FIXME"
                    [/message]
                    [message]
                        speaker=Kaldyn
                        message= _ "FIXME"
                    [/message]
                    [message]
                        speaker=Dragochan
                        message= _ "FIXME"
                    [/message]
                [/case]
                [case]
                    value=6

                    [message]
                        speaker=Kaldyn
                        message= _ "FIXME"
                    [/message]
                    [message]
                        speaker=Dragochan
                        message= _ "FIXME"
                    [/message]
                [/case]
                [case]
                    value=11

                    [message]
                        speaker=Dragochan
                        message= _ "FIXME"
                    [/message]

                    {FADE_OUT_MUSIC}

                    [message]
                        speaker=Kaldyn
                        message= _ "... There’s no way you could ever understand what I’m going through."
                    [/message]

                    {REPLACE_SCENARIO_MUSIC "transience.ogg"}
                    {APPEND_MUSIC "love_theme.ogg"}

                    [message]
                        speaker=Kaldyn
                        message= _ "FIXME"
                    [/message]
                    [message]
                        speaker=Dragochan
                        message= _ "FIXME"
                    [/message]
                [/case]
                [case]
                    value=15

                    {APPEND_MUSIC "journeys_end.ogg"}

                    [message]
                        speaker=Dragochan
                        message= _ "FIXME"
                    [/message]
                [/case]
            [/switch]

            {VARIABLE_OP dialogue_count add 1}

            [allow_undo][/allow_undo]
        [/event]
    [/event]

    [event]
        name=die
        [filter]
            id=Elgair
        [/filter]

        [message]
            speaker=Dragochan
            message= _ "FIXME"
        [/message]

        {VARIABLE iron_shield_acquired yes}

        {ACHIEVE s09}
    [/event]

    [event]
        name=sighted
        [filter]
            side=5
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Dragochan
            message= _ "FIXME"
            scroll=no
        [/message]

        [kill]
            side=2,3,4
            fire_event=no
        [/kill]

        [modify_side]
            side=1
            shroud=no
        [/modify_side]

        [lift_fog]
            [filter_side]
                side=1
            [/filter_side]

            [filter]
                role=lookout
            [/filter]
            radius=1
        [/lift_fog]

        [redraw]
            clear_shroud=yes
        [/redraw]

        [message]
            role=lookout
            message= _ "FIXME"
        [/message]
        [message]
            speaker=Dragochan
            message= _ "FIXME"
        [/message]

        [modify_side]
            side=5
            share_vision=all
        [/modify_side]
        [redraw]
            clear_shroud=yes
        [/redraw]

        {DELAY 750}

        [message]
            speaker=Kaldyn
            message= _ "FIXME"
        [/message]
        [message]
            speaker=Dragochan
            message= _ "FIXME"
        [/message]
        [message]
            speaker=Kaldyn
            message= _ "FIXME"
        [/message]

        [endlevel]
            result=victory
            bonus=no
            carryover_report=no
            {NEW_GOLD_CARRYOVER 100}
        [/endlevel]
    [/event]

    [event]
        name=victory

        {CLEAR_VARIABLE dialogue_count}

        # Reset Dragochan
        {MODIFY_UNIT (id=Dragochan) canrecruit no}
        [unit_overlay]
            id=Dragochan
            image=misc/hero-icon.png
        [/unit_overlay]

        #
        # Restore All
        #

        {MODIFY_UNIT (side=5) side 1}

        [allow_recruit]
            side=1
            type=Bee,Drone
        [/allow_recruit]
    [/event]
[/scenario]
